<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÙ… ÙØ§Ú©ØªÙˆØ±Ø³Ø§Ø² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/sahel-font@v3.4.0/dist/font-face.css" rel="stylesheet" type="text/css" />
    <style>
        :root {
            /* Ù¾Ø§Ù„Øª Ø§ØµÙ„ÛŒ (Ø¢Ø¨ÛŒ) */
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --secondary: #7c3aed;
            --danger: #dc2626;
            --warning: #d97706;
            --success: #059669;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --purple: #8b5cf6;
            --teal: #0d9488;
            --orange: #ea580c;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Ù¾Ø§Ù„Øªâ€ŒÙ‡Ø§ÛŒ Ø±Ù†Ú¯ */
        .palette-blue {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --primary-light: #60a5fa;
            --secondary: #7c3aed;
        }

        .palette-green {
            --primary: #059669;
            --primary-dark: #047857;
            --primary-light: #10b981;
            --secondary: #0d9488;
        }

        .palette-purple {
            --primary: #7c3aed;
            --primary-dark: #6d28d9;
            --primary-light: #8b5cf6;
            --secondary: #2563eb;
        }

        .palette-red {
            --primary: #dc2626;
            --primary-dark: #b91c1c;
            --primary-light: #ef4444;
            --secondary: #d97706;
        }

        .palette-orange {
            --primary: #ea580c;
            --primary-dark: #c2410c;
            --primary-light: #f97316;
            --secondary: #dc2626;
        }

        .palette-teal {
            --primary: #0d9488;
            --primary-dark: #0f766e;
            --primary-light: #14b8a6;
            --secondary: #059669;
        }

        .palette-pink {
            --primary: #db2777;
            --primary-dark: #be185d;
            --primary-light: #ec4899;
            --secondary: #7c3aed;
        }

        .palette-indigo {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-light: #6366f1;
            --secondary: #7c3aed;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Sahel', 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #334155;
            line-height: 1.5;
            overflow-x: hidden;
            font-size: 14px;
        }

        /* Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            border-top: 1px solid #e2e8f0;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--gray);
            transition: all 0.2s ease;
            flex: 1;
            padding: 8px 0;
            border: none;
            background: none;
            cursor: pointer;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn i {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-btn span {
            font-size: 11px;
            font-weight: 600;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            padding-bottom: 70px; /* Ø¨Ø±Ø§ÛŒ Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† */
        }

        .top-header {
            background: linear-gradient(135deg, var(--dark), #334155);
            color: white;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-icon {
            font-size: 1.5em;
        }

        .logo-text {
            font-size: 1em;
            font-weight: 700;
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s ease;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-1px);
        }

        .main-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
        }

        .form-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .form-title {
            font-size: 1.2em;
            font-weight: 800;
            margin-bottom: 20px;
            color: var(--dark);
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            color: var(--dark);
            font-size: 0.9em;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: #f8fafc;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.3s;
            width: 100%;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-purple {
            background: linear-gradient(135deg, var(--purple), #7c3aed);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #b45309);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #b91c1c);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #047857);
        }

        .btn-telegram {
            background: linear-gradient(135deg, #0088cc, #006699);
        }

        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
        }

        .btn-sms {
            background: linear-gradient(135deg, #34B7F1, #0d8bd9);
        }

        .add-cost-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            font-weight: 600;
        }

        .add-cost-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
        }

        .add-cost-btn.danger {
            background: var(--danger);
        }

        .signature-pad {
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            margin-bottom: 15px;
            height: 150px;
            width: 100%;
            touch-action: none;
        }

        .invoice-preview {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }

        .invoice-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .invoice-items {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.9em;
        }

        .invoice-items th, .invoice-items td {
            border: 1px solid #e2e8f0;
            padding: 10px;
            text-align: center;
        }

        .invoice-items th {
            background: #f1f5f9;
            font-weight: 700;
            color: var(--dark);
        }

        .invoice-total {
            text-align: left;
            font-weight: 800;
            font-size: 1.1em;
            margin-top: 15px;
        }

        .invoice-signatures {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
        }

        .signature-box {
            text-align: center;
            width: 45%;
        }

        .signature-line {
            border-top: 1px solid #475569;
            margin-top: 50px;
            padding-top: 8px;
        }

        .success-message {
            background: linear-gradient(135deg, var(--success), #10b981);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin: 15px 0;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.4);
            animation: slideIn 0.5s ease-out;
            font-size: 0.9em;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-message {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 18px;
            border-radius: 12px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .info-title {
            font-size: 1.1em;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .info-content {
            font-size: 0.9em;
            line-height: 1.6;
            opacity: 0.95;
        }

        .tax-calculations {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-right: 3px solid var(--primary);
        }

        .tax-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
            padding: 5px 0;
        }

        .invoice-item-row {
            margin-bottom: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .history-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f8fafc;
        }

        .history-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .history-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.1);
        }

        .history-info {
            flex: 1;
        }

        .history-date {
            font-size: 0.85em;
            color: var(--gray);
            margin-top: 5px;
        }

        .history-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e2e8f0;
        }

        .history-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 10px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
        }

        .email-preview {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .share-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .share-method {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background: #f8fafc;
            transition: all 0.2s;
            cursor: pointer;
        }

        .share-method:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .share-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .share-method.telegram .share-icon { color: #0088cc; }
        .share-method.whatsapp .share-icon { color: #25D366; }
        .share-method.email .share-icon { color: var(--primary); }
        .share-method.sms .share-icon { color: #34B7F1; }

        .share-name {
            font-weight: 700;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .share-desc {
            font-size: 0.8em;
            color: var(--gray);
            text-align: center;
        }

        .print-message {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            text-align: center;
            font-size: 0.9em;
            color: #0369a1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            right: 0;
            left: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            color: white;
            font-size: 1.2em;
            font-weight: 700;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù„Ú¯Ùˆ Ùˆ Ù¾Ø§Ù„Øª */
        .palette-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .palette-item {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }

        .palette-item.active {
            border-color: var(--dark);
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .template-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: all 0.2s;
            text-align: center;
        }

        .template-item:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .template-item.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
        }

        .template-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .template-name {
            font-weight: 600;
            font-size: 0.9em;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù† */
        .customer-select-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .customer-select-container select {
            flex: 1;
        }

        .customer-select-container button {
            flex-shrink: 0;
        }

        .customers-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            background: #f8fafc;
        }

        .customer-item {
            padding: 12px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
            cursor: pointer;
        }

        .customer-item:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.1);
            transform: translateY(-2px);
        }

        .customer-info h4 {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .customer-info p {
            font-size: 0.85em;
            color: var(--gray);
        }

        .customer-actions {
            display: flex;
            gap: 5px;
        }

        .customer-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ */
        .date-input-group {
            display: flex;
            gap: 10px;
        }

        .date-input-group input {
            text-align: center;
        }

        .year-input {
            flex: 2;
        }

        .month-input, .day-input {
            flex: 1;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 800px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
                border-radius: 20px;
                overflow: hidden;
            }
            
            .btn {
                font-size: 15px;
                padding: 16px 24px;
            }
            
            .share-methods {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .template-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .palette-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }
            
            .form-container {
                padding: 16px;
            }
            
            .invoice-details {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .invoice-signatures {
                flex-direction: column;
                gap: 30px;
            }
            
            .signature-box {
                width: 100%;
            }
            
            .btn {
                padding: 16px;
            }
            
            .invoice-items {
                font-size: 0.8em;
            }
            
            .invoice-items th, .invoice-items td {
                padding: 6px;
            }
            
            .share-methods {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: 1fr;
            }
            
            .palette-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media print {
            body {
                margin: 0;
                padding: 0;
                font-size: 12px;
                line-height: 1.3;
            }
            
            .no-print {
                display: none !important;
            }
            
            .invoice-preview {
                box-shadow: none;
                border: 1px solid #000;
                width: 100%;
                margin: 0;
                padding: 15px;
                page-break-inside: avoid;
            }
            
            .container {
                max-width: 100%;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                min-height: auto;
            }
            
            .invoice-items {
                font-size: 10px;
                width: 100%;
            }
            
            .invoice-items th, .invoice-items td {
                padding: 4px;
                border: 1px solid #000;
            }
            
            .tax-calculations {
                border: 1px solid #000;
                background: #fff !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .tax-row {
                margin-bottom: 4px;
                font-size: 10px;
            }
            
            .invoice-header h2 {
                font-size: 16px;
                margin-bottom: 5px;
            }
            
            .invoice-header p {
                font-size: 10px;
                margin: 2px 0;
            }
            
            .invoice-details {
                font-size: 10px;
            }
            
            .invoice-details h4 {
                font-size: 11px;
                margin-bottom: 3px;
            }
            
            .invoice-details p {
                margin: 1px 0;
                font-size: 9px;
            }
            
            .invoice-signatures {
                margin-top: 20px;
            }
            
            .signature-line {
                margin-top: 30px;
            }
            
            @page {
                size: landscape;
                margin: 10mm;
            }
        }
    </style>
</head>
<body class="palette-blue">
    <div class="container">
        <div class="top-header">
            <div class="logo">
                <div class="logo-icon">ğŸ§¾</div>
                <div class="logo-text">Ø³ÛŒØ³ØªÙ… ÙØ§Ú©ØªÙˆØ±Ø³Ø§Ø² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="header-btn" onclick="showHistory()">
                    <span>ğŸ“‹</span> ØªØ§Ø±ÛŒØ®Ú†Ù‡
                </button>
                <button class="header-btn" onclick="showCustomersModal()">
                    <span>ğŸ‘¥</span> Ù…Ø´ØªØ±ÛŒØ§Ù†
                </button>
                <a href="index.html" class="header-btn">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</a>
            </div>
        </div>

        <div class="main-content">
            <div class="form-container">
                <h2 class="form-title"><i class="fas fa-file-invoice"></i> Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</h2>
                
                <div class="form-group">
                    <label for="invoice-type"><i class="fas fa-tag"></i> Ù†ÙˆØ¹ ÙØ§Ú©ØªÙˆØ±:</label>
                    <select id="invoice-type">
                        <option value="sale">ÙØ±ÙˆØ´</option>
                        <option value="purchase">Ø®Ø±ÛŒØ¯</option>
                        <option value="proforma">Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±</option>
                        <option value="return">Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-number"><i class="fas fa-hashtag"></i> Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±:</label>
                    <input type="text" id="invoice-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" value="FA-1403-001">
                </div>

                <div class="form-group">
                    <label for="invoice-date"><i class="fas fa-calendar"></i> ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ± (Ø´Ù…Ø³ÛŒ):</label>
                    <div class="date-input-group">
                        <input type="number" id="invoice-year" class="form-control year-input" placeholder="Ø³Ø§Ù„" value="1403" min="1300" max="1500">
                        <input type="number" id="invoice-month" class="form-control month-input" placeholder="Ù…Ø§Ù‡" value="1" min="1" max="12">
                        <input type="number" id="invoice-day" class="form-control day-input" placeholder="Ø±ÙˆØ²" value="1" min="1" max="31">
                    </div>
                    <small style="display: block; margin-top: 5px; color: var(--gray);">ÙØ±Ù…Øª: Ø³Ø§Ù„/Ù…Ø§Ù‡/Ø±ÙˆØ² (Ø´Ù…Ø³ÛŒ)</small>
                </div>

                <div class="form-group">
                    <label for="invoice-due-date"><i class="fas fa-calendar-check"></i> ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯ (Ø´Ù…Ø³ÛŒ):</label>
                    <div class="date-input-group">
                        <input type="number" id="due-year" class="form-control year-input" placeholder="Ø³Ø§Ù„" value="1403" min="1300" max="1500">
                        <input type="number" id="due-month" class="form-control month-input" placeholder="Ù…Ø§Ù‡" value="1" min="1" max="12">
                        <input type="number" id="due-day" class="form-control day-input" placeholder="Ø±ÙˆØ²" value="7" min="1" max="31">
                    </div>
                </div>

                <div class="form-group">
                    <label for="invoice-seller"><i class="fas fa-user-tie"></i> ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="invoice-seller" placeholder="Ù†Ø§Ù… ÙØ±ÙˆØ´Ù†Ø¯Ù‡ / Ø´Ø±Ú©Øª" value="Ø´Ø±Ú©Øª Ù†Ù…ÙˆÙ†Ù‡ ØªØ¬Ø§Ø±Øª">
                </div>

                <div class="form-group">
                    <label for="seller-tax-id"><i class="fas fa-id-card"></i> Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="12345678901">
                </div>

                <div class="form-group">
                    <label for="seller-address"><i class="fas fa-map-marker-alt"></i> Ø¢Ø¯Ø±Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <textarea id="seller-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ ÙØ±ÙˆØ´Ù†Ø¯Ù‡">ØªÙ‡Ø±Ø§Ù†ØŒ Ø®ÛŒØ§Ø¨Ø§Ù† Ù†Ù…ÙˆÙ†Ù‡ØŒ Ù¾Ù„Ø§Ú© Û±Û²Û³</textarea>
                </div>

                <div class="form-group">
                    <label for="seller-phone"><i class="fas fa-phone"></i> ØªÙ„ÙÙ† ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <input type="text" id="seller-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ ÙØ±ÙˆØ´Ù†Ø¯Ù‡" value="021-12345678">
                </div>

                <div class="form-group">
                    <label for="invoice-buyer"><i class="fas fa-user"></i> Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <div class="customer-select-container">
                        <select id="invoice-buyer-select" onchange="selectCustomer()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</option>
                        </select>
                        <button type="button" class="add-cost-btn" onclick="showCustomersModal()">
                            <i class="fas fa-users"></i>
                        </button>
                    </div>
                    <input type="text" id="invoice-buyer" placeholder="Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± / Ø´Ø±Ú©Øª" style="margin-top: 10px;">
                </div>

                <div class="form-group">
                    <label for="buyer-tax-id"><i class="fas fa-id-card"></i> Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ/Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="buyer-tax-id" placeholder="Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø®Ø±ÛŒØ¯Ø§Ø±">
                </div>

                <div class="form-group">
                    <label for="buyer-address"><i class="fas fa-map-marker-alt"></i> Ø¢Ø¯Ø±Ø³ Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <textarea id="buyer-address" rows="2" placeholder="Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ Ø®Ø±ÛŒØ¯Ø§Ø±"></textarea>
                </div>

                <div class="form-group">
                    <label for="buyer-phone"><i class="fas fa-phone"></i> ØªÙ„ÙÙ† Ø®Ø±ÛŒØ¯Ø§Ø±:</label>
                    <input type="text" id="buyer-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ Ø®Ø±ÛŒØ¯Ø§Ø±">
                </div>

                <h3 style="margin: 25px 0 15px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-shopping-cart"></i> Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±
                </h3>
                
                <div id="invoice-items">
                    <div class="invoice-item-row">
                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                            <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name" value="Ù„Ù¾â€ŒØªØ§Ù¾ ØªØ¬Ø§Ø±ÛŒ">
                            <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="2" min="1">
                            <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price" value="25000000">
                            <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="5" min="0" max="100">
                            <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 8px; font-size: 0.9em;">Ù„Ù¾â€ŒØªØ§Ù¾ Û±Ûµ Ø§ÛŒÙ†Ú†ÛŒØŒ Core i7ØŒ 16GB RAM</textarea>
                    </div>
                </div>

                <button type="button" class="add-cost-btn" onclick="addInvoiceItem()" style="margin-bottom: 20px;">
                    <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù„Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
                </button>

                <div class="form-group">
                    <label for="payment-terms"><i class="fas fa-credit-card"></i> Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</label>
                    <select id="payment-terms">
                        <option value="cash">Ù†Ù‚Ø¯ÛŒ</option>
                        <option value="check">Ú†Ú©</option>
                        <option value="installment">Ø§Ù‚Ø³Ø§Ø·</option>
                        <option value="transfer">Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="invoice-notes"><i class="fas fa-sticky-note"></i> ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ø´Ø±Ø§ÛŒØ·:</label>
                    <textarea id="invoice-notes" rows="3" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§Ø¶Ø§ÙÛŒØŒ Ø´Ø±Ø§ÛŒØ· Ú¯Ø§Ø±Ø§Ù†ØªÛŒØŒ Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„ Ùˆ ...">Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¸Ø±Ù Û³ Ø±ÙˆØ² Ú©Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ ØªØ­ÙˆÛŒÙ„ Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯. Ú¯Ø§Ø±Ø§Ù†ØªÛŒ Û±Û¸ Ù…Ø§Ù‡Ù‡</textarea>
                </div>

                <h3 style="margin: 25px 0 15px; color: var(--dark); display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-signature"></i> Ø§Ù…Ø¶Ø§Ù‡Ø§
                </h3>
                
                <div class="signature-pad-container">
                    <label>Ø§Ù…Ø¶Ø§ÛŒ ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</label>
                    <canvas class="signature-pad" id="seller-signature-pad"></canvas>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button type="button" class="add-cost-btn danger" onclick="clearSellerSignature()">
                            <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù…Ø¶Ø§
                        </button>
                        <button type="button" class="add-cost-btn" onclick="loadSampleSignature()">
                            <i class="fas fa-signature"></i> Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="seller-stamp"><i class="fas fa-stamp"></i> Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡ (URL ØªØµÙˆÛŒØ±):</label>
                    <input type="text" id="seller-stamp" placeholder="Ø¢Ø¯Ø±Ø³ ØªØµÙˆÛŒØ± Ù…Ù‡Ø± Ø´Ø±Ú©Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>

                <button class="btn btn-purple" onclick="generateInvoice()">
                    <i class="fas fa-file-invoice"></i> Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-warning no-print" onclick="saveInvoiceTemplate()">
                    <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ±
                </button>

                <button class="btn btn-danger no-print" onclick="clearInvoiceForm()">
                    <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
                </button>
            </div>

            <div class="invoice-preview no-print" id="invoice-preview" style="display: none;">
                <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>

            <div class="form-container no-print" id="invoice-actions" style="display: none;">
                <h2 class="form-title"><i class="fas fa-tasks"></i> Ø§Ù‚Ø¯Ø§Ù…Ø§Øª ÙØ§Ú©ØªÙˆØ±</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <button class="btn" onclick="downloadInvoiceAsPDF()">
                        <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF
                    </button>
                    <button class="btn btn-purple" onclick="printInvoice()">
                        <i class="fas fa-print"></i> Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <button class="btn btn-warning" onclick="showShareModal()">
                        <i class="fas fa-share-alt"></i> Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ±
                    </button>
                    <button class="btn btn-success" onclick="saveInvoiceToHistory()">
                        <i class="fas fa-history"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡
                    </button>
                </div>
            </div>

            <div class="form-container no-print">
                <h2 class="form-title"><i class="fas fa-info-circle"></i> Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±</h2>
                <div class="info-message">
                    <div class="info-title">Ù†Ú©Ø§Øª Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±</div>
                    <div class="info-content">
                        â€¢ Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø¨Ø§ÛŒØ¯ Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´Ø¯<br>
                        â€¢ Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ Û±Û° Ù…ÛŒÙ„ÛŒÙˆÙ† Ø§Ù…Ø¶Ø§ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª<br>
                        â€¢ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø¨Ù‡ Ù…Ø¯Øª Û±Û° Ø³Ø§Ù„ Ø¨Ø§ÛŒØ¯ Ø¢Ø±Ø´ÛŒÙˆ Ø´ÙˆÙ†Ø¯
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù†Ø§ÙˆØ¨Ø±ÛŒ Ù¾Ø§ÛŒÛŒÙ† -->
    <div class="bottom-nav no-print">
        <button class="nav-btn" onclick="showTemplateModal()">
            <i class="fas fa-layer-group"></i>
            <span>Ø§Ù„Ú¯Ùˆ</span>
        </button>
        <button class="nav-btn" onclick="showPaletteModal()">
            <i class="fas fa-palette"></i>
            <span>Ù¾Ø§Ù„Øª</span>
        </button>
        <button class="nav-btn" onclick="downloadImage()">
            <i class="fas fa-download"></i>
            <span>Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³</span>
        </button>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
    <div class="modal-overlay" id="history-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
                </h2>
                <button class="close-btn" onclick="closeModal('history-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="history-container" id="history-list">
                    <!-- Ù„ÛŒØ³Øª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="clearHistory()">
                    <i class="fas fa-trash"></i> Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªØ§Ø±ÛŒØ®Ú†Ù‡
                </button>
                <button class="btn" onclick="closeModal('history-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ Ù…Ø´ØªØ±ÛŒØ§Ù† -->
    <div class="modal-overlay" id="customers-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-users"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†
                </h2>
                <button class="close-btn" onclick="closeModal('customers-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="new-customer-name" placeholder="Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ" class="form-control" style="flex: 2;">
                        <input type="text" id="new-customer-phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" class="form-control" style="flex: 1;">
                        <button class="add-cost-btn" onclick="addNewCustomer()">
                            <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù†
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <input type="text" id="customer-search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ø´ØªØ±ÛŒ..." class="form-control" onkeyup="searchCustomers()">
                </div>
                
                <div class="customers-list" id="customers-list">
                    <!-- Ù„ÛŒØ³Øª Ù…Ø´ØªØ±ÛŒØ§Ù† -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('customers-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù„Ú¯Ùˆ -->
    <div class="modal-overlay" id="template-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-layer-group"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ù„Ú¯ÙˆÛŒ ÙØ§Ú©ØªÙˆØ±
                </h2>
                <button class="close-btn" onclick="closeModal('template-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="template-grid">
                    <div class="template-item active" onclick="changeTemplate('modern')">
                        <div class="template-icon">ğŸ§¾</div>
                        <div class="template-name">Ù…Ø¯Ø±Ù†</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('classic')">
                        <div class="template-icon">ğŸ“„</div>
                        <div class="template-name">Ú©Ù„Ø§Ø³ÛŒÚ©</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('minimal')">
                        <div class="template-icon">ğŸ“</div>
                        <div class="template-name">Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('professional')">
                        <div class="template-icon">ğŸ’¼</div>
                        <div class="template-name">Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('colorful')">
                        <div class="template-icon">ğŸ¨</div>
                        <div class="template-name">Ø±Ù†Ú¯ÛŒ</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('simple')">
                        <div class="template-icon">ğŸ“‹</div>
                        <div class="template-name">Ø³Ø§Ø¯Ù‡</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('elegant')">
                        <div class="template-icon">âœ¨</div>
                        <div class="template-name">Ø´ÛŒÚ©</div>
                    </div>
                    <div class="template-item" onclick="changeTemplate('business')">
                        <div class="template-icon">ğŸ¢</div>
                        <div class="template-name">ØªØ¬Ø§Ø±ÛŒ</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('template-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ -->
    <div class="modal-overlay" id="palette-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-palette"></i> Ø§Ù†ØªØ®Ø§Ø¨ Ù¾Ø§Ù„Øª Ø±Ù†Ú¯
                </h2>
                <button class="close-btn" onclick="closeModal('palette-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="palette-grid">
                    <div class="palette-item active" style="background: #2563eb;" onclick="changePalette('blue')" title="Ø¢Ø¨ÛŒ"></div>
                    <div class="palette-item" style="background: #059669;" onclick="changePalette('green')" title="Ø³Ø¨Ø²"></div>
                    <div class="palette-item" style="background: #7c3aed;" onclick="changePalette('purple')" title="Ø¨Ù†ÙØ´"></div>
                    <div class="palette-item" style="background: #dc2626;" onclick="changePalette('red')" title="Ù‚Ø±Ù…Ø²"></div>
                    <div class="palette-item" style="background: #ea580c;" onclick="changePalette('orange')" title="Ù†Ø§Ø±Ù†Ø¬ÛŒ"></div>
                    <div class="palette-item" style="background: #0d9488;" onclick="changePalette('teal')" title="ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ"></div>
                    <div class="palette-item" style="background: #db2777;" onclick="changePalette('pink')" title="ØµÙˆØ±ØªÛŒ"></div>
                    <div class="palette-item" style="background: #4f46e5;" onclick="changePalette('indigo')" title="Ù†ÛŒÙ„ÛŒ"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('palette-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± -->
    <div class="modal-overlay" id="image-modal" style="display: none;">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-image"></i> Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±
                </h2>
                <button class="close-btn" onclick="closeModal('image-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="invoice-image-container" style="text-align: center;">
                    <!-- Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="downloadImageFromModal()">
                    <i class="fas fa-download"></i> Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³
                </button>
                <button class="btn" onclick="closeModal('image-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) -->
    <div class="modal-overlay" id="email-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-envelope"></i> Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ± Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø§ÛŒÙ…ÛŒÙ„
                </h2>
                <button class="close-btn" onclick="closeModal('email-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="email-recipient"><i class="fas fa-user"></i> Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ (Ø§ÛŒÙ…ÛŒÙ„):</label>
                    <input type="email" id="email-recipient" placeholder="Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ (Ù…Ø«Ø§Ù„: info@example.com)" multiple>
                    <small style="display: block; margin-top: 5px; color: var(--gray);">Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú†Ù†Ø¯ Ù†ÙØ±ØŒ Ø§ÛŒÙ…ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§ Ú©Ù†ÛŒØ¯</small>
                </div>
                
                <div class="form-group">
                    <label for="email-subject"><i class="fas fa-tag"></i> Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„:</label>
                    <input type="text" id="email-subject" placeholder="Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„" value="ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ - ">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-eye"></i> Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„:</label>
                    <div class="email-preview" id="email-preview">
                        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ…ÛŒÙ„ -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="sendEmailNow()">
                    <i class="fas fa-paper-plane"></i> Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„
                </button>
                <button class="btn" onclick="closeModal('email-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="share-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-share-alt"></i> Ø§Ø±Ø³Ø§Ù„ ÙØ§Ú©ØªÙˆØ±
                </h2>
                <button class="close-btn" onclick="closeModal('share-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="share-message"><i class="fas fa-comment"></i> Ù¾ÛŒØ§Ù… Ù¾ÛŒØ´â€ŒÙØ±Ø¶:</label>
                    <textarea id="share-message" rows="3" placeholder="Ù¾ÛŒØ§Ù… Ù‡Ù…Ø±Ø§Ù‡ ÙØ§Ú©ØªÙˆØ±">ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø·Ø±Ù {ÙØ±ÙˆØ´Ù†Ø¯Ù‡} Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø´Ù…Ø§Ø±Ù‡ ÙØ§Ú©ØªÙˆØ±: {Ø´Ù…Ø§Ø±Ù‡} - Ù…Ø¨Ù„Øº: {Ù…Ø¨Ù„Øº} ØªÙˆÙ…Ø§Ù†</textarea>
                    <small style="display: block; margin-top: 5px; color: var(--gray);">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù… Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯</small>
                </div>
                
                <div class="share-methods">
                    <div class="share-method telegram" onclick="sendViaTelegram()">
                        <div class="share-icon">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <div class="share-name">ØªÙ„Ú¯Ø±Ø§Ù…</div>
                        <div class="share-desc">Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±</div>
                    </div>
                    
                    <div class="share-method whatsapp" onclick="sendViaWhatsApp()">
                        <div class="share-icon">
                            <i class="fab fa-whatsapp"></i>
                        </div>
                        <div class="share-name">ÙˆØ§ØªØ³Ø§Ù¾</div>
                        <div class="share-desc">Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±</div>
                    </div>
                    
                    <div class="share-method email" onclick="sendInvoiceByEmail()">
                        <div class="share-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="share-name">Ø§ÛŒÙ…ÛŒÙ„</div>
                        <div class="share-desc">Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ú©Ø§Ù…Ù„</div>
                    </div>
                    
                    <div class="share-method sms" onclick="sendViaSMS()">
                        <div class="share-icon">
                            <i class="fas fa-sms"></i>
                        </div>
                        <div class="share-name">Ù¾ÛŒØ§Ù…Ú©</div>
                        <div class="share-desc">Ø§Ø±Ø³Ø§Ù„ Ù…ØªÙ† Ú©Ø§Ù…Ù„</div>
                    </div>
                </div>
                
                <div class="print-message">
                    <i class="fas fa-info-circle"></i> Ø¨Ø±Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ùˆ ÙˆØ§ØªØ³Ø§Ù¾ØŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ…ÛŒÙ„ Ùˆ Ù¾ÛŒØ§Ù…Ú©ØŒ Ù…ØªÙ† Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ± Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="closeModal('share-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="telegram-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fab fa-telegram"></i> Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Ø·Ø±ÛŒÙ‚ ØªÙ„Ú¯Ø±Ø§Ù…
                </h2>
                <button class="close-btn" onclick="closeModal('telegram-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="telegram-username"><i class="fas fa-user"></i> Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…:</label>
                    <input type="text" id="telegram-username" placeholder="@username ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ù…Ø«Ø§Ù„: 09123456789)">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-comment"></i> Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ:</label>
                    <div class="email-preview" id="telegram-preview">
                        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ØªÙ„Ú¯Ø±Ø§Ù… -->
                    </div>
                </div>
                
                <div class="print-message">
                    <i class="fas fa-info-circle"></i> ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ + Ù…ØªÙ† Ø¨Ø§Ù„Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-telegram" onclick="sendTelegramNow()">
                    <i class="fab fa-telegram"></i> Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
                </button>
                <button class="btn" onclick="closeModal('telegram-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="whatsapp-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fab fa-whatsapp"></i> Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Ø·Ø±ÛŒÙ‚ ÙˆØ§ØªØ³Ø§Ù¾
                </h2>
                <button class="close-btn" onclick="closeModal('whatsapp-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="whatsapp-number"><i class="fas fa-phone"></i> Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</label>
                    <input type="text" id="whatsapp-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø¨Ø§ Ú©Ø¯ Ú©Ø´ÙˆØ± (Ù…Ø«Ø§Ù„: 989123456789+)">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-comment"></i> Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ:</label>
                    <div class="email-preview" id="whatsapp-preview">
                        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ÙˆØ§ØªØ³Ø§Ù¾ -->
                    </div>
                </div>
                
                <div class="print-message">
                    <i class="fas fa-info-circle"></i> ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ + Ù…ØªÙ† Ø¨Ø§Ù„Ø§ Ø§Ø±Ø³Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-whatsapp" onclick="sendWhatsAppNow()">
                    <i class="fab fa-whatsapp"></i> Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾
                </button>
                <button class="btn" onclick="closeModal('whatsapp-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="sms-modal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-sms"></i> Ø§Ø±Ø³Ø§Ù„ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾ÛŒØ§Ù…Ú©
                </h2>
                <button class="close-btn" onclick="closeModal('sms-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="sms-number"><i class="fas fa-phone"></i> Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„:</label>
                    <input type="text" id="sms-number" placeholder="Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Ù…Ø«Ø§Ù„: 09123456789)">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-comment"></i> Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ÛŒ (Ù…ØªÙ† Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ±):</label>
                    <div class="email-preview" id="sms-preview">
                        <!-- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù¾ÛŒØ§Ù…Ú© -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sms" onclick="sendSMSNow()">
                    <i class="fas fa-sms"></i> Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…Ú©
                </button>
                <button class="btn" onclick="closeModal('sms-modal')">
                    <i class="fas fa-times"></i> Ø¨Ø³ØªÙ†
                </button>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loading-overlay" style="display: none;">
        <div class="loading-spinner"></div>
        <div id="loading-text">Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§Ú©ØªÙˆØ±...</div>
    </div>

    <script>
        // ============================
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…
        // ============================
        let sellerSignaturePad = null;
        let currentInvoice = null;
        let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 1;
        const MAX_HISTORY_ITEMS = 30;
        let invoiceImageData = null;
        let customers = [];
        let currentTemplate = localStorage.getItem('currentTemplate') || 'modern';
        let currentPalette = localStorage.getItem('currentPalette') || 'blue';
        
        // ============================
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        // ============================
        window.onload = function() {
            initializeSignaturePad();
            loadCustomers();
            loadInvoiceTemplates();
            updateEmailPreview();
            
            // Ø§Ø¹Ù…Ø§Ù„ Ù¾Ø§Ù„Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            applyPalette(currentPalette);
            
            // Ø§Ø¹Ù…Ø§Ù„ Ø§Ù„Ú¯ÙˆÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick').includes(currentTemplate)) {
                    item.classList.add('active');
                }
            });
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener
            document.getElementById('email-subject').addEventListener('input', updateEmailPreview);
            document.getElementById('email-recipient').addEventListener('input', updateEmailPreview);
            document.getElementById('share-message').addEventListener('input', updateShareMessage);
        };
        
        // ============================
        // Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø´ØªØ±ÛŒØ§Ù†
        // ============================
        function loadCustomers() {
            const saved = localStorage.getItem('invoice_customers');
            if (saved) {
                customers = JSON.parse(saved);
            }
            updateCustomerSelect();
        }
        
        function saveCustomers() {
            localStorage.setItem('invoice_customers', JSON.stringify(customers));
        }
        
        function updateCustomerSelect() {
            const select = document.getElementById('invoice-buyer-select');
            select.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø´ØªØ±ÛŒ</option>';
            
            customers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = `${customer.name} - ${customer.phone || ''}`;
                select.appendChild(option);
            });
        }
        
        function showCustomersModal() {
            updateCustomersList();
            document.getElementById('customers-modal').style.display = 'flex';
        }
        
        function updateCustomersList() {
            const list = document.getElementById('customers-list');
            list.innerHTML = '';
            
            if (customers.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.5;"></i>
                        <div>Ù‡ÛŒÚ† Ù…Ø´ØªØ±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
                    </div>
                `;
                return;
            }
            
            customers.forEach(customer => {
                const div = document.createElement('div');
                div.className = 'customer-item';
                div.onclick = () => selectCustomerFromModal(customer);
                div.innerHTML = `
                    <div class="customer-info">
                        <h4>${customer.name}</h4>
                        <p>ğŸ“± ${customer.phone || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'}</p>
                        <p>ğŸ“ ${customer.address || 'Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡'}</p>
                    </div>
                    <div class="customer-actions">
                        <button class="add-cost-btn danger" onclick="deleteCustomer(${customer.id}, event)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                list.appendChild(div);
            });
        }
        
        function selectCustomerFromModal(customer) {
            document.getElementById('invoice-buyer').value = customer.name;
            document.getElementById('buyer-tax-id').value = customer.taxId || '';
            document.getElementById('buyer-address').value = customer.address || '';
            document.getElementById('buyer-phone').value = customer.phone || '';
            
            // Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø± dropdown
            document.getElementById('invoice-buyer-select').value = customer.id;
            
            closeModal('customers-modal');
            showSuccessMessage('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯');
        }
        
        function selectCustomer() {
            const select = document.getElementById('invoice-buyer-select');
            const customerId = parseInt(select.value);
            
            if (!customerId) return;
            
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('invoice-buyer').value = customer.name;
                document.getElementById('buyer-tax-id').value = customer.taxId || '';
                document.getElementById('buyer-address').value = customer.address || '';
                document.getElementById('buyer-phone').value = customer.phone || '';
                showSuccessMessage('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø´ØªØ±ÛŒ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯');
            }
        }
        
        function addNewCustomer() {
            const name = document.getElementById('new-customer-name').value.trim();
            const phone = document.getElementById('new-customer-phone').value.trim();
            
            if (!name) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const newCustomer = {
                id: Date.now(),
                name: name,
                phone: phone,
                address: '',
                taxId: '',
                email: ''
            };
            
            customers.push(newCustomer);
            saveCustomers();
            updateCustomerSelect();
            updateCustomersList();
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
            document.getElementById('new-customer-name').value = '';
            document.getElementById('new-customer-phone').value = '';
            
            showSuccessMessage('Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
        }
        
        function deleteCustomer(customerId, event) {
            event.stopPropagation();
            
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                customers = customers.filter(c => c.id !== customerId);
                saveCustomers();
                updateCustomerSelect();
                updateCustomersList();
                showSuccessMessage('Ù…Ø´ØªØ±ÛŒ Ø­Ø°Ù Ø´Ø¯');
            }
        }
        
        function searchCustomers() {
            const searchTerm = document.getElementById('customer-search').value.toLowerCase();
            const items = document.querySelectorAll('.customer-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }
        
        // ============================
        // Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù„Ú¯ÙˆÙ‡Ø§ Ùˆ Ù¾Ø§Ù„Øªâ€ŒÙ‡Ø§
        // ============================
        function showTemplateModal() {
            document.getElementById('template-modal').style.display = 'flex';
        }
        
        function showPaletteModal() {
            document.getElementById('palette-modal').style.display = 'flex';
        }
        
        function changeTemplate(templateName) {
            currentTemplate = templateName;
            localStorage.setItem('currentTemplate', templateName);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            document.querySelectorAll('.template-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.template-item').classList.add('active');
            
            showSuccessMessage(`Ø§Ù„Ú¯ÙˆÛŒ ${templateName} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯`);
            closeModal('template-modal');
            
            // Ø§Ú¯Ø± ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø§Ø³ØªØŒ Ø¢Ù† Ø±Ø§ Ø¨Ø§ Ø§Ù„Ú¯ÙˆÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ù†
            if (currentInvoice) {
                displayInvoicePreview(currentInvoice);
            }
        }
        
        function changePalette(paletteName) {
            currentPalette = paletteName;
            localStorage.setItem('currentPalette', paletteName);
            applyPalette(paletteName);
            
            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
            document.querySelectorAll('.palette-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            showSuccessMessage(`Ù¾Ø§Ù„Øª ${paletteName} Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯`);
            closeModal('palette-modal');
        }
        
        function applyPalette(paletteName) {
            // Ø­Ø°Ù Ú©Ù„Ø§Ø³â€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ù„Øª Ù‚Ø¨Ù„ÛŒ
            document.body.classList.remove(
                'palette-blue', 'palette-green', 'palette-purple', 
                'palette-red', 'palette-orange', 'palette-teal',
                'palette-pink', 'palette-indigo'
            );
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ù„Ø§Ø³ Ù¾Ø§Ù„Øª Ø¬Ø¯ÛŒØ¯
            document.body.classList.add(`palette-${paletteName}`);
        }
        
        // ============================
        // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
        // ============================
        function getPersianDate() {
            const year = document.getElementById('invoice-year').value || '1403';
            const month = document.getElementById('invoice-month').value || '1';
            const day = document.getElementById('invoice-day').value || '1';
            
            const monthNames = [
                'ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±',
                'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'
            ];
            
            return `${year}/${month}/${day} - ${monthNames[parseInt(month)-1] || ''}`;
        }
        
        function getDueDate() {
            const year = document.getElementById('due-year').value;
            const month = document.getElementById('due-month').value;
            const day = document.getElementById('due-day').value;
            
            if (!year || !month || !day) return '';
            
            const monthNames = [
                'ÙØ±ÙˆØ±Ø¯ÛŒÙ†', 'Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª', 'Ø®Ø±Ø¯Ø§Ø¯', 'ØªÛŒØ±', 'Ù…Ø±Ø¯Ø§Ø¯', 'Ø´Ù‡Ø±ÛŒÙˆØ±',
                'Ù…Ù‡Ø±', 'Ø¢Ø¨Ø§Ù†', 'Ø¢Ø°Ø±', 'Ø¯ÛŒ', 'Ø¨Ù‡Ù…Ù†', 'Ø§Ø³ÙÙ†Ø¯'
            ];
            
            return `${year}/${month}/${day} - ${monthNames[parseInt(month)-1] || ''}`;
        }
        
        // ============================
        // ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ÙØ§Ú©ØªÙˆØ± (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        // ============================
        function initializeSignaturePad() {
            const canvas = document.getElementById('seller-signature-pad');
            if (canvas) {
                sellerSignaturePad = new SignaturePad(canvas, {
                    backgroundColor: 'white',
                    penColor: 'rgb(0, 0, 0)',
                    minWidth: 1,
                    maxWidth: 3
                });
                
                const resizeCanvas = () => {
                    const ratio = Math.max(window.devicePixelRatio || 1, 1);
                    canvas.width = canvas.offsetWidth * ratio;
                    canvas.height = canvas.offsetHeight * ratio;
                    canvas.getContext("2d").scale(ratio, ratio);
                    sellerSignaturePad.clear();
                };
                
                window.addEventListener("resize", resizeCanvas);
                resizeCanvas();
            }
        }
        
        function clearSellerSignature() {
            if (sellerSignaturePad) {
                sellerSignaturePad.clear();
            }
        }
        
        function loadSampleSignature() {
            if (sellerSignaturePad) {
                showSuccessMessage('Ø§Ù…Ø¶Ø§ÛŒ Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
            }
        }
        
        function addInvoiceItem() {
            const itemsContainer = document.getElementById('invoice-items');
            const itemRow = document.createElement('div');
            itemRow.className = 'invoice-item-row';
            itemRow.innerHTML = `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <input type="text" placeholder="Ù†Ø§Ù… Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª" class="item-name">
                    <input type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯" class="item-quantity" value="1" min="1">
                    <input type="number" placeholder="Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯" class="item-price">
                    <input type="number" placeholder="ØªØ®ÙÛŒÙ %" class="item-discount" value="0" min="0" max="100">
                    <button type="button" class="add-cost-btn danger" onclick="removeInvoiceItem(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <textarea class="item-description" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø§Ù„Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" rows="2" style="width: 100%; margin-top: 8px; font-size: 0.9em;"></textarea>
            `;
            itemsContainer.appendChild(itemRow);
        }
        
        function removeInvoiceItem(button) {
            if (document.querySelectorAll('.invoice-item-row').length > 1) {
                button.closest('.invoice-item-row').remove();
            } else {
                alert('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø¢ÛŒØªÙ… Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯');
            }
        }
        
        function generateInvoice() {
            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§ÛŒÙ‡
            const type = document.getElementById('invoice-type').value;
            const number = document.getElementById('invoice-number').value || `FA-1403-${invoiceCounter.toString().padStart(3, '0')}`;
            const date = getPersianDate();
            const dueDate = getDueDate();
            const seller = document.getElementById('invoice-seller').value;
            const sellerTaxId = document.getElementById('seller-tax-id').value;
            const sellerAddress = document.getElementById('seller-address').value;
            const sellerPhone = document.getElementById('seller-phone').value;
            const buyer = document.getElementById('invoice-buyer').value;
            const buyerTaxId = document.getElementById('buyer-tax-id').value;
            const buyerAddress = document.getElementById('buyer-address').value;
            const buyerPhone = document.getElementById('buyer-phone').value;
            const paymentTerms = document.getElementById('payment-terms').value;
            const notes = document.getElementById('invoice-notes').value;

            if (!seller || !buyer) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±ÙˆØ´Ù†Ø¯Ù‡ Ùˆ Ø®Ø±ÛŒØ¯Ø§Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
            const items = [];
            let subtotal = 0;
            let totalDiscount = 0;
            
            document.querySelectorAll('.invoice-item-row').forEach(row => {
                const name = row.querySelector('.item-name').value;
                const quantity = parseInt(row.querySelector('.item-quantity').value) || 0;
                const price = parseInt(row.querySelector('.item-price').value) || 0;
                const discount = parseInt(row.querySelector('.item-discount').value) || 0;
                const description = row.querySelector('.item-description').value;

                if (name && quantity > 0 && price > 0) {
                    const itemTotal = quantity * price;
                    const itemDiscount = (itemTotal * discount) / 100;
                    const itemNet = itemTotal - itemDiscount;
                    
                    subtotal += itemTotal;
                    totalDiscount += itemDiscount;
                    
                    items.push({
                        name,
                        quantity,
                        price,
                        discount,
                        description,
                        total: itemTotal,
                        discountAmount: itemDiscount,
                        net: itemNet
                    });
                }
            });

            if (items.length === 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ú©Ø§Ù„Ø§ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ù…Ø§Ù„ÛŒØ§ØªÛŒ
            const taxRate = 9;
            const taxAmount = (subtotal - totalDiscount) * taxRate / 100;
            const totalAmount = subtotal - totalDiscount + taxAmount;

            // Ø§Ù…Ø¶Ø§
            let sellerSignature = null;
            if (sellerSignaturePad && !sellerSignaturePad.isEmpty()) {
                sellerSignature = sellerSignaturePad.toDataURL();
            }

            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
            currentInvoice = {
                id: Date.now(),
                type,
                number,
                date,
                dueDate,
                seller: {
                    name: seller,
                    taxId: sellerTaxId,
                    address: sellerAddress,
                    phone: sellerPhone
                },
                buyer: {
                    name: buyer,
                    taxId: buyerTaxId,
                    address: buyerAddress,
                    phone: buyerPhone
                },
                items,
                subtotal,
                totalDiscount,
                taxRate,
                taxAmount,
                totalAmount,
                paymentTerms,
                notes,
                sellerSignature,
                template: currentTemplate,
                palette: currentPalette,
                createdAt: new Date().toLocaleDateString('fa-IR'),
                timestamp: Date.now()
            };

            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´
            displayInvoicePreview(currentInvoice);
            document.getElementById('invoice-actions').style.display = 'block';
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³ Ø§Ø² ÙØ§Ú©ØªÙˆØ±
            createInvoiceImage();
            
            showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯');
            
            updateEmailPreview();
            updateShareMessage();
        }
        
        function createInvoiceImage() {
            const previewContainer = document.getElementById('invoice-preview');
            if (!previewContainer || previewContainer.style.display === 'none') {
                return;
            }
            
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±...');
            
            html2canvas(previewContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                allowTaint: true,
                foreignObjectRendering: false,
                imageTimeout: 15000,
                onclone: function(clonedDoc) {
                    const clonedPreview = clonedDoc.getElementById('invoice-preview');
                    if (clonedPreview) {
                        clonedPreview.style.boxShadow = 'none';
                        clonedPreview.style.border = '1px solid #000';
                        clonedPreview.style.padding = '15px';
                    }
                }
            }).then(canvas => {
                invoiceImageData = canvas.toDataURL('image/png');
                hideLoading();
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³:', error);
                hideLoading();
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ (Ø§Ù…Ú©Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø¹Ú©Ø³ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯)');
            });
        }
        
        function displayInvoicePreview(invoice) {
            const previewContainer = document.getElementById('invoice-preview');
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };

            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };

            // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ù„Ú¯ÙˆÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            let invoiceContent = '';
            
            switch(currentTemplate) {
                case 'classic':
                    invoiceContent = createClassicTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'minimal':
                    invoiceContent = createMinimalTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'professional':
                    invoiceContent = createProfessionalTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'colorful':
                    invoiceContent = createColorfulTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'simple':
                    invoiceContent = createSimpleTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'elegant':
                    invoiceContent = createElegantTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                case 'business':
                    invoiceContent = createBusinessTemplate(invoice, typeNames, paymentTermsNames);
                    break;
                default: // modern
                    invoiceContent = createModernTemplate(invoice, typeNames, paymentTermsNames);
            }
            
            previewContainer.innerHTML = invoiceContent;
            previewContainer.style.display = 'block';
            
            previewContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function createModernTemplate(invoice, typeNames, paymentTermsNames) {
            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right;">
                            <div><strong>${item.name}</strong></div>
                            ${item.description ? `<div style="font-size: 0.8em; color: #666; margin-top: 5px;">${item.description}</div>` : ''}
                        </td>
                        <td>${item.quantity.toLocaleString()}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.discount}%</td>
                        <td>${item.discountAmount.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            return `
                <div class="invoice-header">
                    <h2>ÙØ§Ú©ØªÙˆØ± ${typeNames[invoice.type]}</h2>
                    <p><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> ${invoice.number} | <strong>ØªØ§Ø±ÛŒØ®:</strong> ${invoice.date}</p>
                    ${invoice.dueDate ? `<p><strong>ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯:</strong> ${invoice.dueDate}</p>` : ''}
                </div>

                <div class="invoice-details">
                    <div>
                        <h4>ÙØ±ÙˆØ´Ù†Ø¯Ù‡:</h4>
                        <p><strong>${invoice.seller.name}</strong></p>
                        ${invoice.seller.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.seller.taxId}</p>` : ''}
                        ${invoice.seller.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.seller.address}</p>` : ''}
                        ${invoice.seller.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.seller.phone}</p>` : ''}
                    </div>
                    <div>
                        <h4>Ø®Ø±ÛŒØ¯Ø§Ø±:</h4>
                        <p><strong>${invoice.buyer.name}</strong></p>
                        ${invoice.buyer.taxId ? `<p>Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${invoice.buyer.taxId}</p>` : ''}
                        ${invoice.buyer.address ? `<p>Ø¢Ø¯Ø±Ø³: ${invoice.buyer.address}</p>` : ''}
                        ${invoice.buyer.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.buyer.phone}</p>` : ''}
                    </div>
                </div>

                <table class="invoice-items">
                    <thead>
                        <tr>
                            <th>Ø±Ø¯ÛŒÙ</th>
                            <th>Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª</th>
                            <th>ØªØ¹Ø¯Ø§Ø¯</th>
                            <th>Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>ØªØ®ÙÛŒÙ %</th>
                            <th>Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ (ØªÙˆÙ…Ø§Ù†)</th>
                            <th>Ø¬Ù…Ø¹ (ØªÙˆÙ…Ø§Ù†)</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                </table>

                <div class="tax-calculations" style="page-break-inside: avoid;">
                    <div class="tax-row">
                        <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                        <span>${invoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>ØªØ®ÙÛŒÙ:</span>
                        <span>${invoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row">
                        <span>Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${invoice.taxRate}%):</span>
                        <span>${invoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                    <div class="tax-row" style="border-top: 1px solid #ddd; padding-top: 8px; font-weight: bold; font-size: 1.1em;">
                        <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                        <span>${invoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                    </div>
                </div>

                ${invoice.notes ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border-right: 3px solid var(--primary); page-break-inside: avoid;">
                        <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${invoice.notes}
                    </div>
                ` : ''}

                <div style="margin-top: 20px; padding: 12px; background: #f0f9ff; border-radius: 8px; page-break-inside: avoid;">
                    <strong>Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> ${paymentTermsNames[invoice.paymentTerms]}
                </div>

                <div class="invoice-signatures" style="page-break-inside: avoid;">
                    <div class="signature-box">
                        <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        ${invoice.sellerSignature ? 
                            `<img src="${invoice.sellerSignature}" style="max-width: 200px; max-height: 80px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;">` : 
                            '<div class="signature-line"></div>'
                        }
                    </div>
                    <div class="signature-box">
                        <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div class="signature-line"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 25px; font-size: 0.85em; color: #666; padding-top: 15px; border-top: 1px solid #e2e8f0; page-break-inside: avoid;">
                    Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ùˆ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ù‡Ø± Ùˆ Ø§Ù…Ø¶Ø§ÛŒ ÙÛŒØ²ÛŒÚ©ÛŒ Ù†Ø¯Ø§Ø±Ø¯
                </div>
            `;
        }
        
        function createClassicTemplate(invoice, typeNames, paymentTermsNames) {
            // Ø§Ù„Ú¯ÙˆÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© (Ø´Ø¨ÛŒÙ‡ Ø¨Ù‡ Ù†Ù…ÙˆÙ†Ù‡ ØªØµÙˆÛŒØ± Ø´Ù…Ø§)
            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right; font-size: 0.9em;">
                            <div><strong>${item.name}</strong></div>
                            ${item.description ? `<div style="color: #666;">${item.description}</div>` : ''}
                        </td>
                        <td>${item.quantity.toLocaleString()}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.discount}%</td>
                        <td>${item.discountAmount.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="border: 2px solid #000; padding: 20px; border-radius: 5px;">
                    <div class="invoice-header" style="border-bottom: 3px solid #000;">
                        <h2 style="font-size: 1.5em; margin-bottom: 10px;">ÙØ§Ú©ØªÙˆØ± ${typeNames[invoice.type]}</h2>
                        <p style="font-size: 0.9em;"><strong>Ø´Ù…Ø§Ø±Ù‡:</strong> ${invoice.number} | <strong>ØªØ§Ø±ÛŒØ®:</strong> ${invoice.date}</p>
                    </div>

                    <div class="invoice-details" style="margin: 20px 0;">
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
                            <h4 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">ÙØ±ÙˆØ´Ù†Ø¯Ù‡</h4>
                            <p><strong>${invoice.seller.name}</strong></p>
                            ${invoice.seller.address ? `<p>${invoice.seller.address}</p>` : ''}
                            ${invoice.seller.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.seller.phone}</p>` : ''}
                        </div>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 5px;">
                            <h4 style="border-bottom: 1px solid #ccc; padding-bottom: 5px; margin-bottom: 10px;">Ø®Ø±ÛŒØ¯Ø§Ø±</h4>
                            <p><strong>${invoice.buyer.name}</strong></p>
                            ${invoice.buyer.address ? `<p>${invoice.buyer.address}</p>` : ''}
                            ${invoice.buyer.phone ? `<p>ØªÙ„ÙÙ†: ${invoice.buyer.phone}</p>` : ''}
                        </div>
                    </div>

                    <table class="invoice-items" style="border: 1px solid #000; margin: 20px 0;">
                        <thead>
                            <tr style="background: #e0e0e0;">
                                <th style="border: 1px solid #000;">Ø±Ø¯ÛŒÙ</th>
                                <th style="border: 1px solid #000; text-align: right;">Ø´Ø±Ø­ Ú©Ø§Ù„Ø§ / Ø®Ø¯Ù…Øª</th>
                                <th style="border: 1px solid #000;">ØªØ¹Ø¯Ø§Ø¯</th>
                                <th style="border: 1px solid #000;">Ù‚ÛŒÙ…Øª ÙˆØ§Ø­Ø¯</th>
                                <th style="border: 1px solid #000;">ØªØ®ÙÛŒÙ %</th>
                                <th style="border: 1px solid #000;">Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ</th>
                                <th style="border: 1px solid #000;">Ø¬Ù…Ø¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div style="background: #f9f9f9; padding: 15px; border: 1px solid #ccc; margin: 20px 0; border-right: 4px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                            <span><strong>${invoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <span><strong>${invoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>Ù…Ø§Ù„ÛŒØ§Øª (${invoice.taxRate}%):</span>
                            <span><strong>${invoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #000; font-size: 1.2em;">
                            <span>Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                            <span><strong>${invoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</strong></span>
                        </div>
                    </div>

                    ${invoice.notes ? `
                        <div style="background: #fff8e1; padding: 10px; border: 1px dashed #ffb300; margin: 15px 0;">
                            <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${invoice.notes}
                        </div>
                    ` : ''}

                    <div style="margin-top: 30px; display: flex; justify-content: space-between;">
                        <div style="text-align: center; width: 45%;">
                            <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ùˆ Ù…Ù‡Ø± ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                            ${invoice.sellerSignature ? 
                                `<img src="${invoice.sellerSignature}" style="max-width: 180px; max-height: 70px; margin-top: 10px;">` : 
                                '<div style="border-top: 1px solid #000; margin-top: 60px; padding-top: 5px;"></div>'
                            }
                        </div>
                        <div style="text-align: center; width: 45%;">
                            <div style="font-weight: bold; margin-bottom: 10px;">Ø§Ù…Ø¶Ø§ Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                            <div style="border-top: 1px solid #000; margin-top: 60px; padding-top: 5px;"></div>
                        </div>
                    </div>

                    <div style="text-align: center; margin-top: 30px; font-size: 0.8em; color: #666; padding-top: 10px; border-top: 1px solid #ccc;">
                        ${invoice.seller.name} - ${invoice.seller.phone || ''}
                    </div>
                </div>
            `;
        }
        
        function createMinimalTemplate(invoice, typeNames, paymentTermsNames) {
            // Ø§Ù„Ú¯ÙˆÛŒ Ù…ÛŒÙ†ÛŒÙ…Ø§Ù„
            let itemsHtml = '';
            invoice.items.forEach((item, index) => {
                itemsHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td style="text-align: right;">${item.name}</td>
                        <td>${item.quantity}</td>
                        <td>${item.price.toLocaleString()}</td>
                        <td>${item.net.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            return `
                <div style="padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                        <h2 style="font-size: 1.3em; margin-bottom: 5px; color: var(--dark);">ÙØ§Ú©ØªÙˆØ± ${typeNames[invoice.type]}</h2>
                        <p style="color: var(--gray); font-size: 0.9em;">${invoice.number} - ${invoice.date}</p>
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 0.9em;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px; color: var(--dark);">ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                            <div>${invoice.seller.name}</div>
                            ${invoice.seller.phone ? `<div>${invoice.seller.phone}</div>` : ''}
                        </div>
                        <div style="text-align: left;">
                            <div style="font-weight: bold; margin-bottom: 5px; color: var(--dark);">Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                            <div>${invoice.buyer.name}</div>
                            ${invoice.buyer.phone ? `<div>${invoice.buyer.phone}</div>` : ''}
                        </div>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9em;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--primary);">
                                <th style="padding: 10px; text-align: center;">#</th>
                                <th style="padding: 10px; text-align: right;">Ø´Ø±Ø­</th>
                                <th style="padding: 10px; text-align: center;">ØªØ¹Ø¯Ø§Ø¯</th>
                                <th style="padding: 10px; text-align: center;">Ù‚ÛŒÙ…Øª</th>
                                <th style="padding: 10px; text-align: center;">Ø¬Ù…Ø¹</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #eee;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Ø¬Ù…Ø¹ Ú©Ù„:</span>
                            <span>${invoice.subtotal.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>ØªØ®ÙÛŒÙ:</span>
                            <span>${invoice.totalDiscount.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Ù…Ø§Ù„ÛŒØ§Øª:</span>
                            <span>${invoice.taxAmount.toLocaleString()}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-weight: bold;">
                            <span>Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª:</span>
                            <span>${invoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                    </div>

                    ${invoice.notes ? `
                        <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px; font-size: 0.85em;">
                            <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong> ${invoice.notes}
                        </div>
                    ` : ''}

                    <div style="margin-top: 40px; display: flex; justify-content: space-between; font-size: 0.8em; color: var(--gray);">
                        <div>${paymentTermsNames[invoice.paymentTerms]}</div>
                        <div>${new Date().toLocaleDateString('fa-IR')}</div>
                    </div>
                </div>
            `;
        }
        
        // Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (professional, colorful, simple, elegant, business) Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø´Ø§Ø¨Ù‡
        
        function createProfessionalTemplate(invoice, typeNames, paymentTermsNames) {
            return createModernTemplate(invoice, typeNames, paymentTermsNames); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ù‡Ù…Ø§Ù† Ù…Ø¯Ø±Ù†
        }
        
        function createColorfulTemplate(invoice, typeNames, paymentTermsNames) {
            return createModernTemplate(invoice, typeNames, paymentTermsNames); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ù‡Ù…Ø§Ù† Ù…Ø¯Ø±Ù†
        }
        
        function createSimpleTemplate(invoice, typeNames, paymentTermsNames) {
            return createModernTemplate(invoice, typeNames, paymentTermsNames); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ù‡Ù…Ø§Ù† Ù…Ø¯Ø±Ù†
        }
        
        function createElegantTemplate(invoice, typeNames, paymentTermsNames) {
            return createModernTemplate(invoice, typeNames, paymentTermsNames); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ù‡Ù…Ø§Ù† Ù…Ø¯Ø±Ù†
        }
        
        function createBusinessTemplate(invoice, typeNames, paymentTermsNames) {
            return createModernTemplate(invoice, typeNames, paymentTermsNames); // Ù…ÙˆÙ‚ØªØ§Ù‹ Ù‡Ù…Ø§Ù† Ù…Ø¯Ø±Ù†
        }
        
        // ============================
        // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³
        // ============================
        function downloadImage() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³...');
            
            const previewContainer = document.getElementById('invoice-preview');
            if (!previewContainer || previewContainer.style.display === 'none') {
                hideLoading();
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            html2canvas(previewContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                allowTaint: true,
                foreignObjectRendering: false,
                imageTimeout: 15000,
                onclone: function(clonedDoc) {
                    const clonedPreview = clonedDoc.getElementById('invoice-preview');
                    if (clonedPreview) {
                        clonedPreview.style.boxShadow = 'none';
                        clonedPreview.style.border = '1px solid #000';
                        clonedPreview.style.padding = '20px';
                    }
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `ÙØ§Ú©ØªÙˆØ±_${currentInvoice.number}_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                
                hideLoading();
                showSuccessMessage('Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                hideLoading();
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³:', error);
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }
        
        function downloadImageFromModal() {
            const img = document.getElementById('invoice-image-modal');
            if (img && img.src) {
                const link = document.createElement('a');
                link.download = `ÙØ§Ú©ØªÙˆØ±_${currentInvoice.number}.png`;
                link.href = img.src;
                link.click();
                showSuccessMessage('Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }
        }
        
        // ============================
        // ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø§ Ø¹Ú©Ø³
        // ============================
        function saveInvoiceToHistory() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            // Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…ÙˆØ¬ÙˆØ¯
            let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³ Ø§Ø² ÙØ§Ú©ØªÙˆØ± ÙØ¹Ù„ÛŒ
            const previewContainer = document.getElementById('invoice-preview');
            if (previewContainer && previewContainer.style.display !== 'none') {
                html2canvas(previewContainer, {
                    scale: 1,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    const invoiceImage = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¹Ú©Ø³ Ø¨Ù‡ ÙØ§Ú©ØªÙˆØ±
                    currentInvoice.image = invoiceImage;
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø´Ù…Ø§Ø±Ù‡
                    const existingIndex = invoices.findIndex(inv => inv.id === currentInvoice.id);
                    if (existingIndex !== -1) {
                        invoices[existingIndex] = currentInvoice;
                    } else {
                        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯
                        invoices.push(currentInvoice);
                        
                        // Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§
                        if (invoices.length > MAX_HISTORY_ITEMS) {
                            invoices = invoices.slice(-MAX_HISTORY_ITEMS);
                        }
                    }
                    
                    // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± localStorage
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                    
                    // Ø§ÙØ²Ø§ÛŒØ´ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ ÙØ§Ú©ØªÙˆØ±
                    invoiceCounter++;
                    localStorage.setItem('invoiceCounter', invoiceCounter.toString());
                    
                    showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ø¹Ú©Ø³ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
                }).catch(error => {
                    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¹Ú©Ø³ ØªØ§Ø±ÛŒØ®Ú†Ù‡:', error);
                    showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯ (Ø¨Ø¯ÙˆÙ† Ø¹Ú©Ø³)');
                });
            }
        }
        
        function showHistory() {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const historyList = document.getElementById('history-list');
            
            if (invoices.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: var(--gray);">
                        <i class="fas fa-inbox" style="font-size: 3em; margin-bottom: 15px;"></i>
                        <div>ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</div>
                    </div>
                `;
            } else {
                let historyHtml = '';
                // Ù†Ù…Ø§ÛŒØ´ Ø¨Ù‡ ØªØ±ØªÛŒØ¨ Ù…Ø¹Ú©ÙˆØ³ (Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                [...invoices].reverse().forEach((invoice, index) => {
                    historyHtml += `
                        <div class="history-item" onclick="viewInvoiceFromHistory('${invoice.id}')">
                            <div class="history-info">
                                <div style="font-weight: bold;">${invoice.number}</div>
                                <div style="font-size: 0.9em;">${invoice.seller.name} â†’ ${invoice.buyer.name}</div>
                                <div class="history-date">${invoice.createdAt} - ${formatNumber(invoice.totalAmount)} ØªÙˆÙ…Ø§Ù†</div>
                            </div>
                            <div class="history-image">
                                ${invoice.image ? `<img src="${invoice.image}" alt="ÙØ§Ú©ØªÙˆØ± ${invoice.number}" style="width: 100%; height: 100%; object-fit: cover;">` : '<div style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center;"><i class="fas fa-file-invoice" style="font-size: 24px; color: #ccc;"></i></div>'}
                            </div>
                        </div>
                    `;
                });
                historyList.innerHTML = historyHtml;
            }
            
            document.getElementById('history-modal').style.display = 'flex';
        }
        
        function viewInvoiceFromHistory(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const invoice = invoices.find(inv => inv.id == invoiceId);
            
            if (!invoice) return;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
            if (invoice.image) {
                document.getElementById('invoice-image-container').innerHTML = `
                    <img src="${invoice.image}" alt="ÙØ§Ú©ØªÙˆØ± ${invoice.number}" style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                `;
                document.getElementById('image-modal').style.display = 'flex';
            } else {
                // Ø§Ú¯Ø± Ø¹Ú©Ø³ Ù†Ø¯Ø§Ø±ÛŒÙ…ØŒ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ú©Ù†ÛŒÙ…
                restoreInvoice(invoiceId);
            }
        }
        
        // ============================
        // ØªÙˆØ§Ø¨Ø¹ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        // ============================
        function restoreInvoice(invoiceId) {
            const invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            const invoice = invoices.find(inv => inv.id == invoiceId);
            
            if (invoice) {
                currentInvoice = invoice;
                displayInvoicePreview(invoice);
                document.getElementById('invoice-actions').style.display = 'block';
                
                // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±
                document.getElementById('invoice-type').value = invoice.type;
                document.getElementById('invoice-number').value = invoice.number;
                
                // Ø¨Ø±Ø§ÛŒ ØªØ§Ø±ÛŒØ® Ø¨Ø§ÛŒØ¯ Ø±Ø´ØªÙ‡ Ø±Ø§ Ø¨Ù‡ Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù ØªÙ‚Ø³ÛŒÙ… Ú©Ù†ÛŒÙ…
                if (invoice.date) {
                    const dateParts = invoice.date.split('/');
                    if (dateParts.length >= 3) {
                        document.getElementById('invoice-year').value = dateParts[0];
                        document.getElementById('invoice-month').value = dateParts[1];
                        document.getElementById('invoice-day').value = dateParts[2].split(' ')[0];
                    }
                }
                
                // ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯
                if (invoice.dueDate) {
                    const dueParts = invoice.dueDate.split('/');
                    if (dueParts.length >= 3) {
                        document.getElementById('due-year').value = dueParts[0];
                        document.getElementById('due-month').value = dueParts[1];
                        document.getElementById('due-day').value = dueParts[2].split(' ')[0];
                    }
                }
                
                document.getElementById('invoice-seller').value = invoice.seller.name;
                document.getElementById('seller-tax-id').value = invoice.seller.taxId || '';
                document.getElementById('seller-address').value = invoice.seller.address || '';
                document.getElementById('seller-phone').value = invoice.seller.phone || '';
                document.getElementById('invoice-buyer').value = invoice.buyer.name;
                document.getElementById('buyer-tax-id').value = invoice.buyer.taxId || '';
                document.getElementById('buyer-address').value = invoice.buyer.address || '';
                document.getElementById('buyer-phone').value = invoice.buyer.phone || '';
                document.getElementById('payment-terms').value = invoice.paymentTerms || 'cash';
                document.getElementById('invoice-notes').value = invoice.notes || '';
                
                // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø§Ù‚Ù„Ø§Ù… ÙØ¹Ù„ÛŒ
                document.getElementById('invoice-items').innerHTML = '';
                
                // Ø§ÙØ²ÙˆØ¯Ù† Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±
                invoice.items.forEach(item => {
                    addInvoiceItem();
                    const rows = document.querySelectorAll('.invoice-item-row');
                    const lastRow = rows[rows.length - 1];
                    
                    lastRow.querySelector('.item-name').value = item.name;
                    lastRow.querySelector('.item-quantity').value = item.quantity;
                    lastRow.querySelector('.item-price').value = item.price;
                    lastRow.querySelector('.item-discount').value = item.discount;
                    lastRow.querySelector('.item-description').value = item.description || '';
                });
                
                closeModal('history-modal');
                showSuccessMessage('ÙØ§Ú©ØªÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯');
                
                document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        function clearHistory() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.')) {
                localStorage.removeItem('invoices');
                showSuccessMessage('ØªØ§Ø±ÛŒØ®Ú†Ù‡ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ù¾Ø§Ú© Ø´Ø¯');
                closeModal('history-modal');
            }
        }
        
        function downloadInvoiceAsPDF() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }

            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ PDF Ø¨Ø§ Ú©ÛŒÙÛŒØª...');
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape',
                unit: 'mm',
                format: 'a4',
                putOnlyUsedFonts: true,
                floatPrecision: 16
            });
            
            const invoiceContent = document.getElementById('invoice-preview');
            
            html2canvas(invoiceContent, { 
                scale: 3,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                windowWidth: invoiceContent.scrollWidth,
                windowHeight: invoiceContent.scrollHeight,
                allowTaint: true,
                foreignObjectRendering: false,
                imageTimeout: 20000,
                onclone: function(clonedDoc) {
                    const clonedPreview = clonedDoc.getElementById('invoice-preview');
                    if (clonedPreview) {
                        clonedPreview.style.boxShadow = 'none';
                        clonedPreview.style.border = '1px solid #000';
                        clonedPreview.style.padding = '20px';
                        clonedPreview.style.fontSize = '12px';
                        
                        const tables = clonedPreview.getElementsByTagName('table');
                        for (let table of tables) {
                            table.style.fontSize = '10px';
                            table.style.borderCollapse = 'collapse';
                        }
                    }
                }
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/jpeg', 1.0);
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();
                
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 10;
                
                doc.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(`ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: ${new Date().toLocaleDateString('fa-IR')}`, pdfWidth - 20, pdfHeight - 10, { align: 'right' });
                doc.text(`Ø³ÛŒØ³ØªÙ… ÙØ§Ú©ØªÙˆØ±Ø³Ø§Ø² Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ`, 20, pdfHeight - 10, { align: 'left' });
                
                doc.save(`ÙØ§Ú©ØªÙˆØ±_${currentInvoice.number}_${Date.now()}.pdf`);
                
                hideLoading();
                showSuccessMessage('PDF Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯');
            }).catch(error => {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ PDF:', error);
                hideLoading();
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ PDF. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
            });
        }
        
        function printInvoice() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            window.print();
        }
        
        function showShareModal() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            document.getElementById('share-modal').style.display = 'flex';
        }
        
        function updateShareMessage() {
            if (!currentInvoice) return;
            
            const messageInput = document.getElementById('share-message');
            let message = messageInput.value;
            
            message = message.replace('{ÙØ±ÙˆØ´Ù†Ø¯Ù‡}', currentInvoice.seller.name);
            message = message.replace('{Ø®Ø±ÛŒØ¯Ø§Ø±}', currentInvoice.buyer.name);
            message = message.replace('{Ø´Ù…Ø§Ø±Ù‡}', currentInvoice.number);
            message = message.replace('{Ù…Ø¨Ù„Øº}', currentInvoice.totalAmount.toLocaleString());
            message = message.replace('{ØªØ§Ø±ÛŒØ®}', currentInvoice.date);
            
            document.getElementById('telegram-preview').innerHTML = `<div style="padding: 8px; background: #f8fafc; border-radius: 4px;">${message}</div>`;
            document.getElementById('whatsapp-preview').innerHTML = `<div style="padding: 8px; background: #f8fafc; border-radius: 4px;">${message}</div>`;
            
            const fullText = createFullInvoiceText();
            document.getElementById('sms-preview').innerHTML = `<div style="padding: 8px; background: #f8fafc; border-radius: 4px; font-size: 0.8em; max-height: 150px; overflow-y: auto;">${fullText}</div>`;
        }
        
        function createFullInvoiceText() {
            if (!currentInvoice) return '';
            
            const typeNames = {
                'sale': 'ÙØ±ÙˆØ´',
                'purchase': 'Ø®Ø±ÛŒØ¯',
                'proforma': 'Ù¾ÛŒØ´â€ŒÙØ§Ú©ØªÙˆØ±',
                'return': 'Ø¨Ø±Ú¯Ø´Øª Ø§Ø² ÙØ±ÙˆØ´'
            };
            
            const paymentTermsNames = {
                'cash': 'Ù†Ù‚Ø¯ÛŒ',
                'check': 'Ú†Ú©',
                'installment': 'Ø§Ù‚Ø³Ø§Ø·',
                'transfer': 'Ú©Ø§Ø±Øª Ø¨Ù‡ Ú©Ø§Ø±Øª'
            };
            
            let itemsText = '';
            currentInvoice.items.forEach((item, index) => {
                itemsText += `${index + 1}. ${item.name}\n`;
                itemsText += `   ØªØ¹Ø¯Ø§Ø¯: ${item.quantity} | Ù‚ÛŒÙ…Øª: ${item.price.toLocaleString()} ØªÙˆÙ…Ø§Ù†\n`;
                itemsText += `   ØªØ®ÙÛŒÙ: ${item.discount}% | Ù…Ø¨Ù„Øº ØªØ®ÙÛŒÙ: ${item.discountAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†\n`;
                if (item.description) {
                    itemsText += `   ØªÙˆØ¶ÛŒØ­Ø§Øª: ${item.description}\n`;
                }
                itemsText += `   Ø¬Ù…Ø¹ Ø±Ø¯ÛŒÙ: ${item.net.toLocaleString()} ØªÙˆÙ…Ø§Ù†\n\n`;
            });
            
            return `
ÙØ§Ú©ØªÙˆØ± ${typeNames[currentInvoice.type]}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø´Ù…Ø§Ø±Ù‡: ${currentInvoice.number}
ØªØ§Ø±ÛŒØ®: ${currentInvoice.date}
${currentInvoice.dueDate ? `ØªØ§Ø±ÛŒØ® Ø³Ø±Ø±Ø³ÛŒØ¯: ${currentInvoice.dueDate}\n` : ''}
ÙØ±ÙˆØ´Ù†Ø¯Ù‡:
${currentInvoice.seller.name}
${currentInvoice.seller.taxId ? `Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.seller.taxId}\n` : ''}${currentInvoice.seller.address ? `Ø¢Ø¯Ø±Ø³: ${currentInvoice.seller.address}\n` : ''}${currentInvoice.seller.phone ? `ØªÙ„ÙÙ†: ${currentInvoice.seller.phone}\n` : ''}
Ø®Ø±ÛŒØ¯Ø§Ø±:
${currentInvoice.buyer.name}
${currentInvoice.buyer.taxId ? `Ú©Ø¯ Ø§Ù‚ØªØµØ§Ø¯ÛŒ: ${currentInvoice.buyer.taxId}\n` : ''}${currentInvoice.buyer.address ? `Ø¢Ø¯Ø±Ø³: ${currentInvoice.buyer.address}\n` : ''}${currentInvoice.buyer.phone ? `ØªÙ„ÙÙ†: ${currentInvoice.buyer.phone}\n` : ''}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø§Ù‚Ù„Ø§Ù… ÙØ§Ú©ØªÙˆØ±:
${itemsText}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø®Ù„Ø§ØµÙ‡ Ù…Ø§Ù„ÛŒ:
Ø¬Ù…Ø¹ Ú©Ù„: ${currentInvoice.subtotal.toLocaleString()} ØªÙˆÙ…Ø§Ù†
ØªØ®ÙÛŒÙ: ${currentInvoice.totalDiscount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ (${currentInvoice.taxRate}%): ${currentInvoice.taxAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª: ${currentInvoice.totalAmount.toLocaleString()} ØªÙˆÙ…Ø§Ù†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø´Ø±Ø§ÛŒØ· Ù¾Ø±Ø¯Ø§Ø®Øª: ${paymentTermsNames[currentInvoice.paymentTerms]}
${currentInvoice.notes ? `ØªÙˆØ¶ÛŒØ­Ø§Øª: ${currentInvoice.notes}\n` : ''}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§Ù„Ú©ØªØ±ÙˆÙ†ÛŒÚ©ÛŒ ØµØ§Ø¯Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.
Ø¨Ø§ ØªØ´Ú©Ø±
${currentInvoice.seller.name}
            `.trim();
        }
        
        function sendViaTelegram() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            closeModal('share-modal');
            document.getElementById('telegram-modal').style.display = 'flex';
        }
        
        function sendViaWhatsApp() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            closeModal('share-modal');
            document.getElementById('whatsapp-modal').style.display = 'flex';
        }
        
        function sendViaSMS() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            closeModal('share-modal');
            document.getElementById('sms-modal').style.display = 'flex';
        }
        
        function sendTelegramNow() {
            const username = document.getElementById('telegram-username').value.trim();
            
            if (!username) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…...');
            
            let message = document.getElementById('share-message').value;
            message = message.replace('{ÙØ±ÙˆØ´Ù†Ø¯Ù‡}', currentInvoice.seller.name);
            message = message.replace('{Ø®Ø±ÛŒØ¯Ø§Ø±}', currentInvoice.buyer.name);
            message = message.replace('{Ø´Ù…Ø§Ø±Ù‡}', currentInvoice.number);
            message = message.replace('{Ù…Ø¨Ù„Øº}', currentInvoice.totalAmount.toLocaleString());
            message = message.replace('{ØªØ§Ø±ÛŒØ®}', currentInvoice.date);
            
            if (invoiceImageData) {
                setTimeout(() => {
                    hideLoading();
                    const encodedMessage = encodeURIComponent(`ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯\n${message}\n\n(ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Øª)`);
                    let telegramLink;
                    
                    if (username.startsWith('@')) {
                        telegramLink = `https://t.me/${username.substring(1)}?text=${encodedMessage}`;
                    } else if (username.startsWith('+') || /^\d+$/.test(username)) {
                        telegramLink = `https://t.me/+${username.replace('+', '')}?text=${encodedMessage}`;
                    } else {
                        telegramLink = `https://t.me/${username}?text=${encodedMessage}`;
                    }
                    
                    window.open(telegramLink, '_blank');
                    showSuccessMessage('Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯');
                    closeModal('telegram-modal');
                    
                    document.getElementById('telegram-username').value = '';
                }, 1000);
            } else {
                hideLoading();
                const encodedMessage = encodeURIComponent(`ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯\n${message}\n\n${createFullInvoiceText()}`);
                let telegramLink;
                
                if (username.startsWith('@')) {
                    telegramLink = `https://t.me/${username.substring(1)}?text=${encodedMessage}`;
                } else if (username.startsWith('+') || /^\d+$/.test(username)) {
                    telegramLink = `https://t.me/+${username.replace('+', '')}?text=${encodedMessage}`;
                } else {
                    telegramLink = `https://t.me/${username}?text=${encodedMessage}`;
                }
                
                window.open(telegramLink, '_blank');
                showSuccessMessage('Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯');
                closeModal('telegram-modal');
                
                document.getElementById('telegram-username').value = '';
            }
        }
        
        function sendWhatsAppNow() {
            const phone = document.getElementById('whatsapp-number').value.trim();
            
            if (!phone) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            showLoading('Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾...');
            
            let message = document.getElementById('share-message').value;
            message = message.replace('{ÙØ±ÙˆØ´Ù†Ø¯Ù‡}', currentInvoice.seller.name);
            message = message.replace('{Ø®Ø±ÛŒØ¯Ø§Ø±}', currentInvoice.buyer.name);
            message = message.replace('{Ø´Ù…Ø§Ø±Ù‡}', currentInvoice.number);
            message = message.replace('{Ù…Ø¨Ù„Øº}', currentInvoice.totalAmount.toLocaleString());
            message = message.replace('{ØªØ§Ø±ÛŒØ®}', currentInvoice.date);
            
            if (invoiceImageData) {
                setTimeout(() => {
                    hideLoading();
                    const encodedMessage = encodeURIComponent(`ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯\n${message}\n\n(ÙØ§Ú©ØªÙˆØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ú©Ø³ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Øª)`);
                    const whatsappLink = `https://wa.me/${phone.replace('+', '')}?text=${encodedMessage}`;
                    
                    window.open(whatsappLink, '_blank');
                    showSuccessMessage('Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯');
                    closeModal('whatsapp-modal');
                    
                    document.getElementById('whatsapp-number').value = '';
                }, 1000);
            } else {
                hideLoading();
                const encodedMessage = encodeURIComponent(`ğŸ“‹ ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯\n${message}\n\n${createFullInvoiceText()}`);
                const whatsappLink = `https://wa.me/${phone.replace('+', '')}?text=${encodedMessage}`;
                
                window.open(whatsappLink, '_blank');
                showSuccessMessage('Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ ÙˆØ§ØªØ³Ø§Ù¾ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯');
                closeModal('whatsapp-modal');
                
                document.getElementById('whatsapp-number').value = '';
            }
        }
        
        function sendSMSNow() {
            const phone = document.getElementById('sms-number').value.trim();
            
            if (!phone) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const fullMessage = createFullInvoiceText();
            const encodedMessage = encodeURIComponent(fullMessage);
            const smsLink = `sms:${phone}?body=${encodedMessage}`;
            
            window.open(smsLink, '_blank');
            showSuccessMessage('Ù¾ÛŒØ§Ù… Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ù¾ÛŒØ§Ù…Ú© Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯');
            closeModal('sms-modal');
            
            document.getElementById('sms-number').value = '';
        }
        
        function sendInvoiceByEmail() {
            if (!currentInvoice) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            closeModal('share-modal');
            
            document.getElementById('email-subject').value = `ÙØ§Ú©ØªÙˆØ± ${currentInvoice.number} - ${currentInvoice.seller.name}`;
            
            document.getElementById('email-modal').style.display = 'flex';
            updateEmailPreview();
        }
        
        function sendEmailNow() {
            const recipient = document.getElementById('email-recipient').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            
            if (!recipient) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            if (!currentInvoice) {
                alert('Ù‡ÛŒÚ† ÙØ§Ú©ØªÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
                return;
            }
            
            const emailBody = createFullInvoiceText();
            
            const emails = recipient.split(',').map(email => email.trim()).filter(email => email);
            
            emails.forEach(email => {
                const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
                window.open(mailtoLink, '_blank');
            });
            
            showSuccessMessage(`Ø§ÛŒÙ…ÛŒÙ„ Ø¨Ø§ Ù…ØªÙ† Ú©Ø§Ù…Ù„ ÙØ§Ú©ØªÙˆØ± Ø¨Ø±Ø§ÛŒ ${emails.length} Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯`);
            closeModal('email-modal');
            
            document.getElementById('email-recipient').value = '';
        }
        
        function updateEmailPreview() {
            const emailPreview = document.getElementById('email-preview');
            const recipient = document.getElementById('email-recipient').value;
            const subject = document.getElementById('email-subject').value;
            
            if (!currentInvoice) {
                emailPreview.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯</div>';
                return;
            }
            
            const fullText = createFullInvoiceText();
            let previewHtml = `
                <div><strong>Ø¨Ù‡:</strong> ${recipient || 'Ø§ÛŒÙ…ÛŒÙ„ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ù†Ø¯Ù‡'}</div>
                <div><strong>Ù…ÙˆØ¶ÙˆØ¹:</strong> ${subject || 'Ù…ÙˆØ¶ÙˆØ¹ Ø§ÛŒÙ…ÛŒÙ„'}</div>
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                    <div style="font-size: 0.8em; max-height: 150px; overflow-y: auto; background: #f8fafc; padding: 8px; border-radius: 4px;">
                        ${fullText.replace(/\n/g, '<br>')}
                    </div>
                </div>
            `;
            
            emailPreview.innerHTML = previewHtml;
        }
        
        function saveInvoiceTemplate() {
            const template = {
                seller: document.getElementById('invoice-seller').value,
                sellerTaxId: document.getElementById('seller-tax-id').value,
                sellerAddress: document.getElementById('seller-address').value,
                sellerPhone: document.getElementById('seller-phone').value,
                paymentTerms: document.getElementById('payment-terms').value
            };
            
            localStorage.setItem('invoiceTemplate', JSON.stringify(template));
            showSuccessMessage('Ù‚Ø§Ù„Ø¨ ÙØ§Ú©ØªÙˆØ± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
        }
        
        function loadInvoiceTemplates() {
            const template = JSON.parse(localStorage.getItem('invoiceTemplate'));
            if (template) {
                document.getElementById('invoice-seller').value = template.seller || '';
                document.getElementById('seller-tax-id').value = template.sellerTaxId || '';
                document.getElementById('seller-address').value = template.sellerAddress || '';
                document.getElementById('seller-phone').value = template.sellerPhone || '';
                document.getElementById('payment-terms').value = template.paymentTerms || 'cash';
            }
        }
        
        function clearInvoiceForm() {
            if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
                document.getElementById('invoice-items').innerHTML = '';
                document.getElementById('invoice-buyer').value = '';
                document.getElementById('buyer-tax-id').value = '';
                document.getElementById('buyer-address').value = '';
                document.getElementById('buyer-phone').value = '';
                document.getElementById('invoice-notes').value = '';
                document.getElementById('seller-stamp').value = '';
                clearSellerSignature();
                
                invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 1;
                document.getElementById('invoice-number').value = `FA-1403-${invoiceCounter.toString().padStart(3, '0')}`;
                
                addInvoiceItem();
                
                document.getElementById('invoice-preview').style.display = 'none';
                document.getElementById('invoice-actions').style.display = 'none';
                currentInvoice = null;
                invoiceImageData = null;
                
                showSuccessMessage('ÙØ±Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function formatNumber(num) {
            return num.toLocaleString();
        }
        
        function showSuccessMessage(message) {
            const existingMessage = document.querySelector('.success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            const successMessage = document.createElement('div');
            successMessage.className = 'success-message';
            successMessage.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                    <i class="fas fa-check-circle"></i>
                    <span>${message}</span>
                </div>
            `;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(successMessage, mainContent.firstChild);
            
            setTimeout(() => {
                if (successMessage.parentElement) {
                    successMessage.remove();
                }
            }, 3000);
        }
        
        function showLoading(message) {
            document.getElementById('loading-text').textContent = message;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }
    </script>
</body>
</html>